<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VECTRA Control Panel</title>

    <!-- Shared VECTRA styles -->
    <link rel="stylesheet" href="/shared/vectra-styles.css">
    <!-- Control Panel specific styles -->
    <link rel="stylesheet" href="/static/control-panel.css">
</head>
<body>
    <div class="artifact-container">
        <!-- Header -->
        <header class="artifact-header">
            <h1>VECTRA Control Panel</h1>
            <div class="connection-status">
                <span class="connection-dot" id="connectionDot"></span>
                <span id="connectionText">Connecting...</span>
                <span class="uptime" id="uptime"></span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="artifact-main">
            <!-- Services Section -->
            <section class="panel mb-md">
                <h2 class="panel-title">Services</h2>
                <div id="servicesList" class="services-list">
                    <div class="loading-placeholder">Loading services...</div>
                </div>
            </section>

            <!-- Quick Links Section -->
            <section class="panel mb-md">
                <h2 class="panel-title">Open in New Tab</h2>
                <div class="quick-links">
                    <a href="https://rugs.fun" target="_blank" class="btn btn-secondary">
                        rugs.fun
                    </a>
                    <a href="/artifacts/minimal-trading/" target="_blank" class="btn btn-secondary">
                        minimal-trading
                    </a>
                    <a href="/artifacts/recording-control/" target="_blank" class="btn btn-secondary">
                        recording-control
                    </a>
                </div>
            </section>

            <!-- Live Stats Section -->
            <section class="panel">
                <h2 class="panel-title">Live Stats</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Events/sec</div>
                        <div class="stat-value" id="eventsPerSec">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Subscribers</div>
                        <div class="stat-value" id="subscriberCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Phase</div>
                        <div class="stat-value" id="gamePhase">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Tick</div>
                        <div class="stat-value" id="gameTick">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Price</div>
                        <div class="stat-value" id="gamePrice">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Game ID</div>
                        <div class="stat-value font-mono" id="gameId" style="font-size: 0.75rem;">--</div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="artifact-footer">
            <span>Foundation v1.0.0</span>
            <span id="lastEvent">Last event: --</span>
        </footer>
    </div>

    <!-- Foundation WebSocket Client -->
    <script type="module">
        import { FoundationWSClient } from '/shared/foundation-ws-client.js';

        // Initialize client
        const client = new FoundationWSClient();

        // DOM elements
        const connectionDot = document.getElementById('connectionDot');
        const connectionText = document.getElementById('connectionText');
        const uptimeEl = document.getElementById('uptime');
        const servicesListEl = document.getElementById('servicesList');
        const eventsPerSecEl = document.getElementById('eventsPerSec');
        const subscriberCountEl = document.getElementById('subscriberCount');
        const gamePhaseEl = document.getElementById('gamePhase');
        const gameTickEl = document.getElementById('gameTick');
        const gamePriceEl = document.getElementById('gamePrice');
        const gameIdEl = document.getElementById('gameId');
        const lastEventEl = document.getElementById('lastEvent');

        // Event counter for events/sec calculation
        let eventCount = 0;
        let lastEventCountTime = Date.now();

        // Connection status
        client.on('connection', ({ connected }) => {
            connectionDot.className = 'connection-dot ' + (connected ? 'connected' : 'disconnected');
            connectionText.textContent = connected ? 'Connected' : 'Disconnected';
        });

        // Game tick events
        client.on('game.tick', (event) => {
            const data = event.data || {};
            eventCount++;

            // Update stats
            if (data.phase) {
                gamePhaseEl.textContent = data.phase;
                gamePhaseEl.className = 'stat-value phase-' + data.phase.toLowerCase();
            }
            if (data.tickCount !== undefined) {
                gameTickEl.textContent = data.tickCount;
            }
            if (data.price !== undefined) {
                gamePriceEl.textContent = data.price.toFixed(2) + 'x';
            }
            if (event.gameId) {
                gameIdEl.textContent = event.gameId.substring(0, 8) + '...';
            }

            lastEventEl.textContent = 'Last event: game.tick @ ' + new Date().toLocaleTimeString();
        });

        // All events (for counting)
        client.on('*', () => {
            eventCount++;
        });

        // Calculate events per second
        setInterval(() => {
            const now = Date.now();
            const elapsed = (now - lastEventCountTime) / 1000;
            const eps = Math.round(eventCount / elapsed);
            eventsPerSecEl.textContent = eps;
            eventCount = 0;
            lastEventCountTime = now;
        }, 1000);

        // HTML escape to prevent XSS from service data
        function esc(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // Fetch and render services
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const data = await response.json();

                if (data.services && data.services.length > 0) {
                    renderServices(data.services);
                } else {
                    servicesListEl.innerHTML = '<div class="no-services">No services registered</div>';
                }
            } catch (error) {
                console.error('Failed to load services:', error);
                servicesListEl.innerHTML = '<div class="error">Failed to load services</div>';
            }
        }

        function renderServices(services) {
            servicesListEl.innerHTML = services.map(svc =>
                '<div class="service-item" data-name="' + esc(svc.name) + '">' +
                    '<div class="service-info">' +
                        '<span class="service-status-dot ' + esc(svc.status) + '"></span>' +
                        '<span class="service-name">' + esc(svc.name) + '</span>' +
                        '<span class="service-port">[port ' + esc(String(svc.port)) + ']</span>' +
                        '<span class="service-status-text">' + esc(svc.status.toUpperCase()) + '</span>' +
                    '</div>' +
                    '<div class="service-actions">' +
                        (svc.status === 'stopped' || svc.status === 'error'
                            ? '<button class="btn btn-success btn-sm" onclick="startService(\'' + esc(svc.name) + '\')">START</button>'
                            : '<button class="btn btn-danger btn-sm" onclick="stopService(\'' + esc(svc.name) + '\')">STOP</button>'
                        ) +
                    '</div>' +
                '</div>'
            ).join('');
        }

        // Service control functions (global for onclick)
        window.startService = async function(name) {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '...';

                const response = await fetch('/api/services/' + name + '/start', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    setTimeout(loadServices, 500);
                } else {
                    alert('Failed to start ' + name + ': ' + result.error);
                }
            } catch (error) {
                console.error('Start service error:', error);
                alert('Error starting ' + name);
            }
            loadServices();
        };

        window.stopService = async function(name) {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '...';

                const response = await fetch('/api/services/' + name + '/stop', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    setTimeout(loadServices, 500);
                } else {
                    alert('Failed to stop ' + name + ': ' + result.error);
                }
            } catch (error) {
                console.error('Stop service error:', error);
                alert('Error stopping ' + name);
            }
            loadServices();
        };

        // Fetch uptime periodically
        async function updateUptime() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                if (data.uptime_seconds) {
                    const mins = Math.floor(data.uptime_seconds / 60);
                    const secs = Math.floor(data.uptime_seconds % 60);
                    uptimeEl.textContent = 'Up: ' + mins + 'm ' + secs + 's';
                }
            } catch (error) {
                // Ignore
            }
        }

        // Poll services for status updates
        setInterval(loadServices, 5000);
        setInterval(updateUptime, 10000);

        // Initial load
        loadServices();
        updateUptime();

        // Connect to Foundation
        client.connect().catch(err => {
            console.error('WebSocket connection failed:', err);
            connectionDot.className = 'connection-dot disconnected';
            connectionText.textContent = 'Connection Failed';
        });
    </script>
</body>
</html>
